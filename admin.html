<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Stock Counter - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <style>
        .admin-form {
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .form-content {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .product-edit {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .product-edit input {
            margin-right: 10px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .category-management {
            margin-top: 15px;
        }
        
        .category-list {
            margin-top: 15px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .category-item:hover {
            background: #f1f5f9;
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-name {
            font-weight: 500;
            color: #4a5568;
            font-size: 1rem;
        }
        
        .category-count {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 2px;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-edit:hover {
            background: #5a67d8;
        }
        
        .btn-delete {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-delete:hover {
            background: #c53030;
        }
        
        .category-edit-input {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }
        
        .category-edit-input input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .category-edit-input button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-save {
            background: #38a169;
            color: white;
        }
        
        .btn-save:hover {
            background: #2f855a;
        }
        
        .btn-cancel {
            background: #718096;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #4a5568;
        }
        
        .unit-management {
            margin-top: 15px;
        }
        
        .unit-list {
            margin-top: 15px;
        }
        
        .unit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .unit-item:hover {
            background: #f1f5f9;
        }
        
        .unit-info {
            flex: 1;
        }
        
        .unit-name {
            font-weight: 500;
            color: #4a5568;
            font-size: 1rem;
        }
        
        .unit-count {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 2px;
        }
        
        .unit-actions {
            display: flex;
            gap: 8px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-row .form-group:last-child {
            flex: none;
        }
        
        .collapsible-section {
            margin-bottom: 15px;
        }
        
        .collapsible-btn {
            width: 100%;
            padding: 15px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            margin-bottom: 2px;
        }
        
        .collapsible-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .collapsible-btn.active {
            background: #5a67d8;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }
        
        .toggle-icon {
            transition: transform 0.2s ease;
        }
        
        .collapsible-btn.active .toggle-icon {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            display: none;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .management-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 15px 20px;
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #cbd5e0;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }
        
        .import-export-section {
            margin-top: 30px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }
        
        .products-section {
            margin-top: 30px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }
        
        .section-header {
            background: #e2e8f0;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .section-header h3 {
            margin: 0 0 5px 0;
            color: #4a5568;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header p {
            margin: 0;
            color: #718096;
            font-size: 0.95rem;
        }
        
        .product-list {
            padding: 20px;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: #f8fafc;
        }
        
        .top-pagination {
            border-bottom: 2px solid #e2e8f0;
        }
        
        .bottom-pagination {
            border-top: 2px solid #e2e8f0;
        }
        
        .pagination-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .pagination-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 8px 12px;
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .page-number:hover {
            background: #cbd5e0;
            border-color: #cbd5e0;
        }
        
        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .category-management {
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-row .form-group {
                min-width: auto;
            }
            
            .management-buttons {
                grid-template-columns: 1fr;
            }
            
            .collapsible-btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .action-btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
        }
        
        .page-ellipsis {
            display: inline-block;
            min-width: 24px;
            text-align: center;
            color: #a0aec0;
            font-size: 1rem;
            font-weight: 600;
            padding: 8px 0 8px 0;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Counter
        </a>
        
        <header>
            <h1><i class="fas fa-cog"></i> Product Management</h1>
            <p>Add, edit, or remove products from your inventory</p>
        </header>

        <div class="collapsible-section">
            <button class="collapsible-btn" data-target="add-product">
                <i class="fas fa-plus"></i> Add New Product
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapsible-content" id="add-product">
                <div class="form-content">
                    <form id="addProductForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">Product Name:</label>
                                <input type="text" id="productName" required placeholder="e.g., Cola bottles">
                            </div>
                            <div class="form-group">
                                <label for="productCategory">Category:</label>
                                <select id="productCategory" required>
                                    <option value="">Select a category</option>
                                    <option value="Soft Drinks">Soft Drinks</option>
                                    <option value="Alcoholic">Alcoholic</option>
                                    <option value="Food">Food</option>
                                    <option value="Snacks">Snacks</option>
                                    <option value="Desserts">Desserts</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productUnit">Unit:</label>
                                <select id="productUnit" required>
                                    <option value="">Select a unit</option>
                                    <option value="bottles">Bottles</option>
                                    <option value="crates">Crates</option>
                                    <option value="kegs">Kegs</option>
                                    <option value="cans">Cans</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="packs">Packs</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="bags">Bags</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productTarget">Target Stock:</label>
                                <input type="number" id="productTarget" min="0" step="1" placeholder="e.g., 3">
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Product
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="management-buttons">
            <button class="collapsible-btn" data-target="manage-categories">
                <i class="fas fa-tags"></i> Manage Categories
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <button class="collapsible-btn" data-target="manage-units">
                <i class="fas fa-ruler"></i> Manage Units
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
        </div>

        <div class="collapsible-content" id="manage-categories">
            <div class="form-content">
                <div class="form-group">
                    <label for="newCategoryName">New Category Name:</label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <input type="text" id="newCategoryName" placeholder="Enter new category name" style="flex: 1;">
                        <button id="addNewCategory" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                <div id="categoryList" class="category-list">
                    <!-- Categories will be listed here -->
                </div>
            </div>
        </div>

        <div class="collapsible-content" id="manage-units">
            <div class="form-content">
                <div class="form-group">
                    <label for="newUnitName">New Unit Name:</label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <input type="text" id="newUnitName" placeholder="Enter new unit name" style="flex: 1;">
                        <button id="addNewUnit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                <div id="unitList" class="unit-list">
                    <!-- Units will be listed here -->
                </div>
            </div>
        </div>

        <div class="products-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Product List</h3>
                <p>Manage your existing products</p>
            </div>
            <div class="pagination top-pagination">
                <button class="pagination-btn" id="prevPageTop" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div class="page-numbers" id="pageNumbersTop">
                    <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" id="nextPageTop">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="productList" class="product-list">
                <!-- Products will be loaded here -->
            </div>
            <div class="pagination bottom-pagination">
                <button class="pagination-btn" id="prevPage" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div class="page-numbers" id="pageNumbers">
                    <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" id="nextPage">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="import-export-section">
            <div class="section-header">
                <h3><i class="fas fa-exchange-alt"></i> Data Management</h3>
                <p>Import or export your product data</p>
            </div>
            <div class="form-content">
                <div class="form-row">
                    <button class="action-btn" id="exportProducts">
                        <i class="fas fa-download"></i> Export Products
                    </button>
                    <button class="action-btn" id="importProducts">
                        <i class="fas fa-upload"></i> Import Products
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        class ProductManager {
            constructor() {
                this.products = this.loadProducts();
                this.categories = this.loadCategories();
                this.units = this.loadUnits();
                this.currentPage = 1;
                this.productsPerPage = 10;
                this.reconcileAndSaveAllCategories();
                this.reconcileAndSaveAllUnits();
                this.init();
            }

            loadProducts() {
                const saved = localStorage.getItem('barStockProducts');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.warn('Failed to load saved products');
                        return [];
                    }
                }
                return [];
            }

            loadCategories() {
                const saved = localStorage.getItem('barStockCategories');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.warn('Failed to load saved categories');
                    }
                }
                return [];
            }

            loadUnits() {
                const saved = localStorage.getItem('barStockUnits');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.warn('Failed to load saved units');
                    }
                }
                // Return default units if none saved
                return ['bottles', 'crates', 'kegs', 'cans', 'pieces', 'packs', 'boxes', 'bags'];
            }

            saveProducts() {
                localStorage.setItem('barStockProducts', JSON.stringify(this.products));
            }

            saveCategories() {
                localStorage.setItem('barStockCategories', JSON.stringify(this.categories));
            }

            saveUnits() {
                localStorage.setItem('barStockUnits', JSON.stringify(this.units));
            }

            reconcileAndSaveAllCategories() {
                const productCategories = [...new Set(this.products.map(p => p.category).filter(Boolean))];
                const existingCategories = this.categories || [];
                const combined = [...new Set([...productCategories, ...existingCategories])];
                this.categories = combined.sort();
                this.saveCategories();
            }

            reconcileAndSaveAllUnits() {
                const productUnits = [...new Set(this.products.map(p => p.unit).filter(Boolean))];
                const existingUnits = this.units || [];
                const combined = [...new Set([...productUnits, ...existingUnits])];
                this.units = combined.sort();
                this.saveUnits();
            }

            init() {
                this.renderProducts();
                this.updateCategoryOptions();
                this.updateUnitOptions();
                this.renderCategoryList();
                this.renderUnitList();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('addProductForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addProduct();
                });

                document.getElementById('addNewCategory').addEventListener('click', () => {
                    this.addNewCategory();
                });

                document.getElementById('addNewUnit').addEventListener('click', () => {
                    this.addNewUnit();
                });

                document.getElementById('exportProducts').addEventListener('click', () => {
                    this.exportProducts();
                });

                document.getElementById('importProducts').addEventListener('click', () => {
                    document.getElementById('importFile').click();
                });

                document.getElementById('importFile').addEventListener('change', (e) => {
                    this.importProducts(e.target.files[0]);
                });

                // Collapsible functionality
                const collapsibleButtons = document.querySelectorAll('.collapsible-btn');
                collapsibleButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetId = button.getAttribute('data-target');
                        this.toggleCollapsible(targetId, button);
                    });
                });

                // Pagination functionality
                document.getElementById('prevPage').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.renderProducts();
                    }
                });

                document.getElementById('nextPage').addEventListener('click', () => {
                    const totalPages = Math.ceil(this.products.length / this.productsPerPage);
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.renderProducts();
                    }
                });

                // Top pagination functionality
                document.getElementById('prevPageTop').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.renderProducts();
                    }
                });

                document.getElementById('nextPageTop').addEventListener('click', () => {
                    const totalPages = Math.ceil(this.products.length / this.productsPerPage);
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.renderProducts();
                    }
                });
            }

            toggleCollapsible(targetId, button) {
                const content = document.getElementById(targetId);
                const isActive = content.classList.contains('active');
                
                // Close all other collapsible sections
                document.querySelectorAll('.collapsible-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.collapsible-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Toggle the clicked section
                if (!isActive) {
                    content.classList.add('active');
                    button.classList.add('active');
                }
            }

            addProduct() {
                const name = document.getElementById('productName').value.trim();
                const categorySelect = document.getElementById('productCategory');
                const unitSelect = document.getElementById('productUnit');
                const target = document.getElementById('productTarget').value.trim();
                let category = categorySelect.value;
                let unit = unitSelect.value;

                if (!name || !category || !unit || !target) {
                    alert('Please fill in all fields');
                    return;
                }

                const newId = this.products.length > 0 ? Math.max(...this.products.map(p => p.id)) + 1 : 1;
                this.products.push({ id: newId, name, category, unit, count: 0, target: parseInt(target) });

                this.saveProducts();
                this.currentPage = 1; // Reset to first page
                this.renderProducts();
                this.updateCategoryOptions();
                this.updateUnitOptions();
                this.renderCategoryList();
                this.renderUnitList();
                document.getElementById('addProductForm').reset();
            }

            editProduct(productId, newName, newCategory, newUnit, newTarget) {
                const product = this.products.find(p => p.id === productId);
                if (product) {
                    product.name = newName.trim();
                    product.category = newCategory;
                    product.unit = newUnit;
                    product.target = newTarget !== undefined && newTarget !== '' ? parseInt(newTarget) : 0;
                    this.saveProducts();
                    this.reconcileAndSaveAllCategories();
                    this.reconcileAndSaveAllUnits();
                    this.renderCategoryList();
                    this.renderUnitList();
                }
            }

            removeProduct(productId) {
                if (confirm('Are you sure you want to remove this product?')) {
                    this.products = this.products.filter(p => p.id !== productId);
                    this.saveProducts();
                    this.reconcileAndSaveAllCategories();
                    
                    // Adjust current page if needed
                    const totalPages = Math.ceil(this.products.length / this.productsPerPage);
                    if (this.currentPage > totalPages && totalPages > 0) {
                        this.currentPage = totalPages;
                    }
                    
                    this.renderProducts();
                    this.renderCategoryList();
                }
            }
            
            addNewCategory() {
                const categoryInput = document.getElementById('newCategoryName');
                const categoryName = categoryInput.value.trim();

                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }

                if (this.categories.includes(categoryName)) {
                    alert('This category already exists');
                    return;
                }

                this.categories.push(categoryName);
                this.categories.sort();
                this.saveCategories();
                this.updateCategoryOptions();
                this.renderCategoryList();
                categoryInput.value = '';
            }

            addNewUnit() {
                const unitInput = document.getElementById('newUnitName');
                const unitName = unitInput.value.trim();

                if (!unitName) {
                    alert('Please enter a unit name');
                    return;
                }

                if (this.units.includes(unitName)) {
                    alert('This unit already exists');
                    return;
                }

                this.units.push(unitName);
                this.units.sort();
                this.saveUnits();
                this.updateUnitOptions();
                this.renderUnitList();
                unitInput.value = '';
            }

            editCategory(oldName) {
                const newName = prompt(`Edit category name:`, oldName);
                if (newName === null || newName.trim() === '') return;

                const newTrimmedName = newName.trim();
                if (newTrimmedName === oldName) return;

                if (this.categories.includes(newTrimmedName)) {
                    alert(`Category "${newTrimmedName}" already exists.`);
                    return;
                }

                this.products.forEach(p => {
                    if (p.category === oldName) {
                        p.category = newTrimmedName;
                    }
                });

                this.categories = this.categories.map(c => c === oldName ? newTrimmedName : c);
                this.categories.sort();
                
                this.saveProducts();
                this.saveCategories();
                this.renderProducts();
                this.updateCategoryOptions();
                this.renderCategoryList();
            }

            deleteCategory(categoryName) {
                const productsInCategory = this.products.filter(p => p.category === categoryName).length;
                let confirmationText = `Are you sure you want to delete the category "${categoryName}"?`;
                if (productsInCategory > 0) {
                    confirmationText += `\n\nNote: ${productsInCategory} product(s) in this category will remain but will have no category assigned.`;
                }

                if (confirm(confirmationText)) {
                    // Instead of deleting products, set their category to empty
                    this.products.forEach(p => {
                        if (p.category === categoryName) {
                            p.category = '';
                        }
                    });
                    
                    // Remove the category from the categories list
                    this.categories = this.categories.filter(c => c !== categoryName);
                    this.saveProducts();
                    this.saveCategories();
                    this.renderProducts();
                    this.updateCategoryOptions();
                    this.renderCategoryList();
                }
            }

            editUnit(oldName) {
                const newName = prompt(`Edit unit name:`, oldName);
                if (newName === null || newName.trim() === '') return;

                const newTrimmedName = newName.trim();
                if (newTrimmedName === oldName) return;

                if (this.units.includes(newTrimmedName)) {
                    alert(`Unit "${newTrimmedName}" already exists.`);
                    return;
                }

                this.products.forEach(p => {
                    if (p.unit === oldName) {
                        p.unit = newTrimmedName;
                    }
                });

                this.units = this.units.map(u => u === oldName ? newTrimmedName : u);
                this.units.sort();
                
                this.saveProducts();
                this.saveUnits();
                this.renderProducts();
                this.updateUnitOptions();
                this.renderUnitList();
            }

            deleteUnit(unitName) {
                const productsWithUnit = this.products.filter(p => p.unit === unitName).length;
                let confirmationText = `Are you sure you want to delete the unit "${unitName}"?`;
                if (productsWithUnit > 0) {
                    confirmationText += `\n\nNote: ${productsWithUnit} product(s) with this unit will remain but will have no unit assigned.`;
                }

                if (confirm(confirmationText)) {
                    // Instead of deleting products, set their unit to empty
                    this.products.forEach(p => {
                        if (p.unit === unitName) {
                            p.unit = '';
                        }
                    });
                    
                    // Remove the unit from the units list
                    this.units = this.units.filter(u => u !== unitName);
                    this.saveProducts();
                    this.saveUnits();
                    this.renderProducts();
                    this.updateUnitOptions();
                    this.renderUnitList();
                }
            }

            renderProducts() {
                const productList = document.getElementById('productList');
                productList.innerHTML = '';
                
                if (!this.products.length) {
                    productList.innerHTML = `<p style=\"text-align: center; color: #718096; padding: 40px;\">No products yet. Add one above.</p>`;
                    this.renderPagination();
                    return;
                }

                // Calculate pagination
                const totalPages = Math.ceil(this.products.length / this.productsPerPage);
                const startIndex = (this.currentPage - 1) * this.productsPerPage;
                const endIndex = startIndex + this.productsPerPage;
                const productsToShow = this.products.slice(startIndex, endIndex);

                productsToShow.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'product-edit';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.gap = '10px';
                    div.style.flexWrap = 'wrap';
                    div.style.marginBottom = '10px';
                    div.style.background = '#f8fafc';
                    div.style.borderRadius = '8px';
                    div.style.padding = '12px';
                    div.style.border = '1px solid #e2e8f0';

                    let categoryOptions = '<option value=\"\" ' + (product.category === '' ? 'selected' : '') + '>No Category</option>';
                    categoryOptions += this.categories
                        .map(cat => `<option value=\"${cat}\" ${product.category === cat ? 'selected' : ''}>${cat}</option>`)
                        .join('');

                    let unitOptions = '<option value=\"\" ' + (product.unit === '' ? 'selected' : '') + '>No Unit</option>';
                    unitOptions += this.units
                        .map(unit => `<option value=\"${unit}\" ${product.unit === unit ? 'selected' : ''}>${unit}</option>`)
                        .join('');

                    div.innerHTML = `
                        <input type=\"text\" value=\"${product.name}\" class=\"product-name-input\" data-id=\"${product.id}\" placeholder=\"Product name\" style=\"flex: 1; min-width: 120px;\">
                        <select class=\"product-category-input\" data-id=\"${product.id}\" style=\"min-width: 120px;\">${categoryOptions}</select>
                        <select class=\"product-unit-input\" data-id=\"${product.id}\" style=\"min-width: 90px;\">${unitOptions}</select>
                        <input type=\"number\" min=\"0\" step=\"1\" value=\"${product.target !== undefined ? product.target : ''}\" class=\"product-target-input\" data-id=\"${product.id}\" placeholder=\"Target\" style=\"width: 60px;\">
                        <span style=\"color: #718096; font-size: 0.9rem; min-width: 60px;\">ID: ${product.id}</span>
                        <button class=\"btn btn-danger btn-small delete-btn\" style=\"padding: 6px 10px; border-radius: 5px; font-size: 1rem; min-width: unset; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;\" title=\"Remove product\" onclick=\"productManager.removeProduct(${product.id})\"><i class=\"fas fa-trash\"></i></button>
                    `;
                    
                    const nameInput = div.querySelector('.product-name-input');
                    const categorySelect = div.querySelector('.product-category-input');
                    const unitSelect = div.querySelector('.product-unit-input');
                    const targetInput = div.querySelector('.product-target-input');

                    const saveChanges = () => this.editProduct(product.id, nameInput.value, categorySelect.value, unitSelect.value, targetInput.value);
                    
                    nameInput.addEventListener('blur', saveChanges);
                    categorySelect.addEventListener('change', saveChanges);
                    unitSelect.addEventListener('change', saveChanges);
                    targetInput.addEventListener('blur', saveChanges);

                    productList.appendChild(div);
                });

                this.renderPagination();
            }

            renderCategoryList() {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';
                if (!this.categories.length) {
                    categoryList.innerHTML = `<p style="color: #718096; text-align: center; padding: 20px;">No categories created. Add one above.</p>`;
                    return;
                }
                
                this.categories.forEach(category => {
                    const productCount = this.products.filter(p => p.category === category).length;
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <div class="category-info">
                            <div class="category-name">${category}</div>
                            <div class="category-count">${productCount} product(s)</div>
                        </div>
                        <div class="category-actions">
                            <button class="btn-edit" onclick="productManager.editCategory('${category}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-delete" onclick="productManager.deleteCategory('${category}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    `;
                    categoryList.appendChild(categoryItem);
                });
            }

            renderUnitList() {
                const unitList = document.getElementById('unitList');
                unitList.innerHTML = '';
                if (!this.units.length) {
                    unitList.innerHTML = `<p style="color: #718096; text-align: center; padding: 20px;">No units created. Add one above.</p>`;
                    return;
                }
                
                this.units.forEach(unit => {
                    const productCount = this.products.filter(p => p.unit === unit).length;
                    const unitItem = document.createElement('div');
                    unitItem.className = 'unit-item';
                    unitItem.innerHTML = `
                        <div class="unit-info">
                            <div class="unit-name">${unit}</div>
                            <div class="unit-count">${productCount} product(s)</div>
                        </div>
                        <div class="unit-actions">
                            <button class="btn-edit" onclick="productManager.editUnit('${unit}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-delete" onclick="productManager.deleteUnit('${unit}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    `;
                    unitList.appendChild(unitItem);
                });
            }

            updateCategoryOptions() {
                const categorySelect = document.getElementById('productCategory');
                let optionsHTML = '<option value="">Select a category</option>';
                this.categories.forEach(cat => {
                    optionsHTML += `<option value="${cat}">${cat}</option>`;
                });
                categorySelect.innerHTML = optionsHTML;
            }

            updateUnitOptions() {
                const unitSelect = document.getElementById('productUnit');
                let optionsHTML = '<option value="">Select a unit</option>';
                this.units.forEach(unit => {
                    optionsHTML += `<option value="${unit}">${unit}</option>`;
                });
                unitSelect.innerHTML = optionsHTML;
            }

            importProducts(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedProducts = JSON.parse(e.target.result);
                        if (Array.isArray(importedProducts)) {
                            // Ensure all products have unit and target fields
                            const processedProducts = importedProducts.map(product => ({
                                ...product,
                                unit: product.unit || '',
                                target: product.target !== undefined ? product.target : 0
                            }));

                            // Merge and deduplicate logic
                            const existingProducts = this.products;
                            // Use a map for fast lookup by name+category+unit
                            const productKey = (p) => `${p.name.toLowerCase()}|${(p.category||'').toLowerCase()}|${(p.unit||'').toLowerCase()}`;
                            const productMap = new Map();
                            // Add existing products first
                            existingProducts.forEach(p => {
                                productMap.set(productKey(p), { ...p });
                            });
                            // Add or update with imported products
                            processedProducts.forEach(p => {
                                productMap.set(productKey(p), { ...p });
                            });
                            // Reassign IDs to keep them unique and sequential
                            let id = 1;
                            const mergedProducts = Array.from(productMap.values()).map(p => ({ ...p, id: id++ }));

                            this.products = mergedProducts;
                            this.saveProducts();
                            this.reconcileAndSaveAllCategories();
                            this.reconcileAndSaveAllUnits();
                            this.currentPage = 1; // Reset to first page
                            this.renderProducts();
                            this.updateCategoryOptions();
                            this.updateUnitOptions();
                            this.renderCategoryList();
                            this.renderUnitList();
                            alert('Products imported and merged successfully!');
                        } else {
                            alert('Invalid file format. Please use a valid JSON file.');
                        }
                    } catch (error) {
                        alert('Error importing products. Please check your file format.');
                    }
                };
                reader.readAsText(file);
            }

            exportProducts() {
                const dataStr = JSON.stringify(this.products, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bar-products.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            renderPagination() {
                const pageNumbers = document.getElementById('pageNumbers');
                const pageNumbersTop = document.getElementById('pageNumbersTop');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                const prevBtnTop = document.getElementById('prevPageTop');
                const nextBtnTop = document.getElementById('nextPageTop');
                
                if (!this.products.length) {
                    pageNumbers.innerHTML = '';
                    pageNumbersTop.innerHTML = '';
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    prevBtnTop.disabled = true;
                    nextBtnTop.disabled = true;
                    return;
                }

                const totalPages = Math.ceil(this.products.length / this.productsPerPage);
                
                // Update previous/next buttons for both top and bottom
                prevBtn.disabled = this.currentPage === 1;
                nextBtn.disabled = this.currentPage === totalPages;
                prevBtnTop.disabled = this.currentPage === 1;
                nextBtnTop.disabled = this.currentPage === totalPages;

                // Helper to generate compact page numbers with ellipsis
                function getPageList(current, total) {
                    const pages = [];
                    if (total <= 3) {
                        for (let i = 1; i <= total; i++) pages.push(i);
                    } else {
                        if (current > 2) pages.push(1);
                        if (current > 3) pages.push('...');
                        if (current > 1) pages.push(current - 1);
                        pages.push(current);
                        if (current < total) pages.push(current + 1);
                        if (current < total - 2) pages.push('...');
                        if (current < total - 1) pages.push(total);
                    }
                    return pages;
                }

                // Generate page numbers for both top and bottom
                const generatePageNumbers = (container) => {
                    container.innerHTML = '';
                    const pageList = getPageList(this.currentPage, totalPages);
                    pageList.forEach(page => {
                        if (page === '...') {
                            const ellipsis = document.createElement('span');
                            ellipsis.className = 'page-ellipsis';
                            ellipsis.textContent = '...';
                            container.appendChild(ellipsis);
                        } else {
                            const pageBtn = document.createElement('button');
                            pageBtn.className = `page-number ${page === this.currentPage ? 'active' : ''}`;
                            pageBtn.textContent = page;
                            pageBtn.addEventListener('click', () => {
                                this.currentPage = page;
                                this.renderProducts();
                            });
                            container.appendChild(pageBtn);
                        }
                    });
                };

                generatePageNumbers(pageNumbers);
                generatePageNumbers(pageNumbersTop);
            }
        }

        const productManager = new ProductManager();
    </script>
</body>
</html> 